---
// Google Analytics Component
// This component handles Google Analytics 4 (GA4) tracking with consent management
// Uses environment variable for the GA ID for better security and flexibility

const GA_ID = import.meta.env.PUBLIC_GA_ID || 'G-JGFB95353H';
---

<!-- Google tag (gtag.js) - Lazy loaded for optimal performance -->
<script define:vars={{ GA_ID }}>
  // Initialize dataLayer immediately
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  
  // Defer loading GTM until after page load or user interaction
  function loadGoogleAnalytics() {
    if (window.gtagLoaded) return;
    window.gtagLoaded = true;
    
    const script = document.createElement('script');
    script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_ID}`;
    script.async = true;
    script.onload = function() {
      // Initialize gtag after script loads
      gtag('js', new Date());
      
      // Initialize with consent mode - default to denied until user makes choice
      gtag('consent', 'default', {
        analytics_storage: 'denied',
        ad_storage: 'denied',
        ad_user_data: 'denied',
        ad_personalization: 'denied',
      });
      
      gtag('config', GA_ID, {
        // Enhanced configuration for better tracking
        page_title: document.title,
        page_location: window.location.href,
        // IP anonymization for privacy
        anonymize_ip: true,
        // Disable advertising features for GDPR compliance
        allow_google_signals: false,
        allow_ad_personalization_signals: false,
        // Disable user ID tracking
        user_id: null,
        // Disable demographic and interest reporting
        allow_display_features: false,
        // Disable enhanced link attribution
        link_attribution: false,
        // Disable cross-domain tracking
        allow_linker: false,
      });
    };
    document.head.appendChild(script);
  }
  
  // Load on user interaction or after 3 seconds
  let analyticsLoaded = false;
  const loadOnInteraction = () => {
    if (!analyticsLoaded) {
      analyticsLoaded = true;
      loadGoogleAnalytics();
      // Remove listeners after loading
      ['scroll', 'click', 'touchstart', 'mousemove'].forEach(event => {
        window.removeEventListener(event, loadOnInteraction, { passive: true });
      });
    }
  };
  
  // Add passive event listeners for user interaction
  ['scroll', 'click', 'touchstart', 'mousemove'].forEach(event => {
    window.addEventListener(event, loadOnInteraction, { passive: true, once: true });
  });
  
  // Also load after 3 seconds if no interaction
  setTimeout(() => {
    if (!analyticsLoaded) {
      analyticsLoaded = true;
      loadGoogleAnalytics();
    }
  }, 3000);

  // Track page views for SPA-like behavior (only if consent granted)
  document.addEventListener('astro:page-load', () => {
    // Only track if analytics consent is granted
    const consent = getCookieConsent();
    if (consent === 'accepted') {
      // Ensure gtag is loaded before tracking
      if (window.gtagLoaded) {
        gtag('config', GA_ID, {
          page_title: document.title,
          page_location: window.location.href,
          anonymize_ip: true,
        });
      } else {
        // Load analytics if not already loaded and consent is given
        loadGoogleAnalytics();
      }
    }
  });

  // Helper function to get cookie consent
  function getCookieConsent() {
    // First try to get from cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'cookie-consent') {
        return value;
      }
    }

    // Fallback to localStorage if cookie not found
    try {
      const storedConsent = localStorage.getItem('cookie-consent');
      if (storedConsent) {
        return storedConsent;
      }
    } catch (e) {
      // Could not read from localStorage
    }

    return null;
  }

  // Helper function to track conversions
  window.trackConversion = function (eventName, parameters = {}) {
    const consent = getCookieConsent();

    if (consent === 'accepted') {
      // Ensure analytics is loaded
      if (!window.gtagLoaded) {
        loadGoogleAnalytics();
        // Queue the event to be sent after loading
        setTimeout(() => {
          if (typeof gtag !== 'undefined') {
            gtag('event', eventName, {
              event_category: 'conversion',
              event_label: parameters.event_label || 'general',
              value: parameters.value || 1,
              currency: 'NOK',
              // Add custom parameters
              custom_parameter_1: parameters.custom_parameter_1,
              custom_parameter_2: parameters.custom_parameter_2,
              // Add page information
              page_title: document.title,
              page_location: window.location.href,
            });
          }
        }, 1000);
      } else if (typeof gtag !== 'undefined') {
        // GTM already loaded, track immediately
        gtag('event', eventName, {
          event_category: 'conversion',
          event_label: parameters.event_label || 'general',
          value: parameters.value || 1,
          currency: 'NOK',
          // Add custom parameters
          custom_parameter_1: parameters.custom_parameter_1,
          custom_parameter_2: parameters.custom_parameter_2,
          // Add page information
          page_title: document.title,
          page_location: window.location.href,
        });
      }
    }
  };

  // Helper function to track thank you page conversion
  window.trackThankYouConversion = function () {
    const consent = getCookieConsent();
    if (consent === 'accepted') {
      if (!window.gtagLoaded) {
        loadGoogleAnalytics();
        setTimeout(() => {
          if (typeof gtag !== 'undefined') {
            gtag('event', 'conversion', {
              send_to: 'AW-1234567890/ABC123DEF456', // Replace with your actual conversion ID
              value: 1.0,
              currency: 'NOK',
              transaction_id: 'thank_you_' + Date.now(),
            });

            gtag('event', 'thank_you_page_view', {
              event_category: 'conversion',
              event_label: 'contact_form_submission',
              value: 1,
            });
          }
        }, 1000);
      } else if (typeof gtag !== 'undefined') {
        gtag('event', 'conversion', {
          send_to: 'AW-1234567890/ABC123DEF456', // Replace with your actual conversion ID
          value: 1.0,
          currency: 'NOK',
          transaction_id: 'thank_you_' + Date.now(),
        });

        gtag('event', 'thank_you_page_view', {
          event_category: 'conversion',
          event_label: 'contact_form_submission',
          value: 1,
        });
      }
    }
  };

  // Listen for consent changes from the cookie banner
  document.addEventListener('consent-updated', (event) => {
    const consent = event.detail.consent;
    if (consent === 'accepted') {
      // Load analytics if not loaded
      if (!window.gtagLoaded) {
        loadGoogleAnalytics();
        // Wait for loading then update consent
        setTimeout(() => {
          if (typeof gtag !== 'undefined') {
            gtag('consent', 'update', {
              analytics_storage: 'granted',
              ad_storage: 'denied',
              ad_user_data: 'denied',
              ad_personalization: 'denied',
            });
            
            // Track the current page view
            gtag('config', GA_ID, {
              page_title: document.title,
              page_location: window.location.href,
              anonymize_ip: true,
            });
          }
        }, 1000);
      } else if (typeof gtag !== 'undefined') {
        // Enable analytics and track current page
        gtag('consent', 'update', {
          analytics_storage: 'granted',
          ad_storage: 'denied',
          ad_user_data: 'denied',
          ad_personalization: 'denied',
        });

        // Track the current page view
        gtag('config', GA_ID, {
          page_title: document.title,
          page_location: window.location.href,
          anonymize_ip: true,
        });
      }
    } else if (window.gtagLoaded && typeof gtag !== 'undefined') {
      // Disable analytics
      gtag('consent', 'update', {
        analytics_storage: 'denied',
        ad_storage: 'denied',
        ad_user_data: 'denied',
        ad_personalization: 'denied',
      });
    }
  });
</script>
